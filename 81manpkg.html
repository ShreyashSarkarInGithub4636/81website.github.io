<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creating 81manorg Linux Packages</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; margin: 20px; }
        h2 { border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        pre { background-color: #f4f4f4; padding: 10px; overflow-x: auto; position: relative; }
        pre button { position: absolute; top: 5px; right: 5px; background-color: #ddd; border: none; padding: 5px 8px; cursor: pointer; font-size: 0.8em; }
         pre button:hover { background-color: #ccc; }
        ul { padding-left: 20px; }
        code { background-color: #f0f0f0; padding: 2px 4px; }
    </style>
</head>
<body>
    <h1>Creating Packages for 81manorg Linux</h1>
    <p>This document will guide you through the process of creating packages for 81manorg Linux using the <code>81pkg-builder</code> script and related tools.</p>

    <h2>Required Files and Tools</h2>
    <ul>
        <li><code>81pkg-builder</code>: The package builder script.</li>
        <li><code>.main</code>: Configuration file for the package.</li>
        <li><code>files/</code>: Directory to contain the source files, libraries, etc.</li>
        <li><code>install.sh.in</code>:  Template for the installation script.</li>
        <li><code>uninstall.sh.in</code>: Template for the uninstallation script.</li>
         <li>A working Linux environment (preferably 81manorg Linux)</li>
    </ul>

    <h2>Step-by-Step Guide</h2>
    <ol>
        <li>
            <h3>Prepare the Package Directory</h3>
            <p>Create a directory for your package (e.g., <code>mypackage</code>). Inside, create the following:</p>
            <ul>
                <li>A <code>.main</code> configuration file.</li>
                <li>A <code>files</code> directory to hold sources and libraries.</li>
                <li><code>install.sh.in</code> and <code>uninstall.sh.in</code> template files.</li>
            </ul>
        </li>
        <li>
            <h3>Create the <code>.main</code> File</h3>
            <p>This file configures the package build process. Example:</p>
            <pre><code id="main-code">
                # package building configuration
                Name=MyCoolApp
                AUTHOR="John Doe"
                OGCODER="Jane Smith"
                COMPILEROFPKG="gcc"
                BUILDER="MyTeam"
                VERSION="1.0.0"
                LIBS=dynamic=libmycool.so,needed=libmyother.so
                depends=libc
                bins=files/mycoolapp
                Installpath=/usr/bin/
                system-program=yes
                ARCH=x86_64
                HEADER=yes
                 CONFIGS=files/config
            </code><button onclick="copyCode('main-code',this)">Copy</button></pre>
            <p>
              *   <code>Name</code>: The name of your package.
              *   <code>AUTHOR</code>: The author of the package.
              *   <code>OGCODER</code>: The original coder.
              *   <code>COMPILEROFPKG</code>: The compiler used, like <code>gcc</code> or <code>musl</code>.
              *   <code>BUILDER</code>: The person or team building the package.
              *   <code>VERSION</code>: The version number.
              *   <code>LIBS</code>: Specify libraries using the syntax <code>dynamic=library.so</code> and `needed=library2.so`
              *    `depends`: Specify package dependencies.
              *   <code>bins</code>: List executable files using <code>files/executable</code> syntax.
              *   <code>Installpath</code>: The installation path.
              *    `system-program`: Whether it is a system program, can be `yes` or `no`.
              *   <code>ARCH</code>: The target architecture (e.g., <code>x86_64</code>, <code>aarch64</code>).
              *   <code>HEADER</code>: Set to <code>yes</code> if including header files.
              *   `CONFIGS`: The path to configuration files.
            </p>
        </li>
        <li>
            <h3>Populate the <code>files/</code> Directory</h3>
           <p> Place your source files, libraries, header files, and configuration files inside of the files folder.</p>
           <ul>
            <li>Libraries inside the `files/`, will be copied to `/usr/lib/`</li>
            <li>Binaries inside `files/`, will be copied to `Installpath`</li>
             <li>Headers inside `files/include/libbb/`, will be copied to `/usr/include/libbb/`</li>
              <li>Configuration inside `files/config/`, will be copied to `/etc/81pkg/packagename/`</li>
            </ul>
        </li>
        <li>
            <h3>Create <code>install.sh.in</code> Template</h3>
            <p>This is a template for your install script. It should install the necessary files and configurations. Example:</p>
            <pre><code id="install-code">
                #!/bin/bash
                # Install script for {{NAME}}

                 # Variables from .main
                 NAME="{{NAME}}"
                 AUTHOR="{{AUTHOR}}"
                 OGCODER="{{OGCODER}}"
                 COMPILEROFPKG="{{COMPILEROFPKG}}"
                 BUILDER="{{BUILDER}}"
                 VERSION="{{VERSION}}"
                 LIBS="{{LIBS}}"
                 depends="{{depends}}"
                 bins="{{bins}}"
                 Installpath="{{Installpath}}"
                 system_program="{{system-program}}"
                 ARCH="{{ARCH}}"
                 HEADER="{{HEADER}}"
                 CONFIGS="{{CONFIGS}}"


                 # Create install paths
                 mkdir -p  "$Installpath"
                 if [[ "$system_program" == "yes" ]] ; then
                    mkdir -p /etc/81pkg/"$NAME"
                    fi

                 if [[ -n "$LIBS" ]]; then
                        IFS=',' read -ra LIB_ARRAY <<< "$LIBS"
                        for lib in "${LIB_ARRAY[@]}"; do
                        if [[ $lib == *"dynamic"* ]] || [[ $lib == *"needed"* ]] ; then
                                echo "installing $lib"
                                cp "$PWD"/libs/"${lib#*=*}"  /usr/lib/
                        fi
                   done
                fi
                if [[ -n "$bins" ]]; then
                    IFS=',' read -ra BIN_ARRAY <<< "$bins"
                    for bin in "${BIN_ARRAY[@]}"; do
                        echo "installing $bin"
                         cp "$PWD"/bin/"${bin#*=*}" "$Installpath"
                   done
                fi
                if [[ "$HEADER" == "yes" ]]; then
                    cp -r  "$PWD"/include/libbb  /usr/include/
                fi
               if [[ -n "$CONFIGS" ]]; then
                    cp -r "$PWD"/configs/* /etc/81pkg/"$NAME"
                fi
                 if [[ "$system_program" == "yes" ]] ; then
                   cp "$PWD"/uninstall.sh /etc/81pkg/"$NAME"
                 fi
                echo "Installation complete for $NAME version: $VERSION."
            </code><button onclick="copyCode('install-code', this)">Copy</button></pre>
        </li>
         <li>
            <h3>Create <code>uninstall.sh.in</code> Template</h3>
            <p>This is the template for your uninstallation script. Example:</p>
            <pre><code id="uninstall-code">
                #!/bin/bash
                 # Uninstall script for {{NAME}}
                 # Variables from .main
                 NAME="{{NAME}}"
                 AUTHOR="{{AUTHOR}}"
                 OGCODER="{{OGCODER}}"
                 COMPILEROFPKG="{{COMPILEROFPKG}}"
                 BUILDER="{{BUILDER}}"
                 VERSION="{{VERSION}}"
                 LIBS="{{LIBS}}"
                 depends="{{depends}}"
                 bins="{{bins}}"
                 Installpath="{{Installpath}}"
                 system_program="{{system-program}}"
                 ARCH="{{ARCH}}"
                 HEADER="{{HEADER}}"
                 CONFIGS="{{CONFIGS}}"

                 if [[ -n "$LIBS" ]]; then
                     IFS=',' read -ra LIB_ARRAY <<< "$LIBS"
                    for lib in "${LIB_ARRAY[@]}"; do
                       if [[ $lib == *"dynamic"* ]] || [[ $lib == *"needed"* ]] ; then
                       echo "uninstalling $lib"
                         rm -f  /usr/lib/"${lib#*=*}"
                      fi
                    done
                fi
                if [[ -n "$bins" ]]; then
                      IFS=',' read -ra BIN_ARRAY <<< "$bins"
                     for bin in "${BIN_ARRAY[@]}"; do
                     echo "uninstalling $bin"
                       rm -f "$Installpath"/"${bin#*=*}"
                   done
                fi
              if [[ "$HEADER" == "yes" ]]; then
                   rm -rf /usr/include/libbb
               fi
                 if [[ -n "$CONFIGS" ]]; then
                     rm -rf /etc/81pkg/"$NAME"
                 fi
                echo "Uninstallation completed for $NAME version: $VERSION"
            </code><button onclick="copyCode('uninstall-code',this)">Copy</button></pre>
        </li>
        <li>
            <h3>Run the <code>81pkg-builder</code> Script</h3>
             <p>Navigate to your package directory in the terminal and run the builder script:</p>
            <pre><code id="builder-run">
                ../81pkg-builder
            </code><button onclick="copyCode('builder-run',this)">Copy</button></pre>
            <p>A new package file named <code>YourPackageName.pkg</code> will be generated in your directory.</p>
        </li>
        <li>
           <h3>81pkg-builder script</h3>
           <p> The `81pkg-builder` script itself.</p>
           <pre><code id="builder-code">
#!/bin/bash

set -e  # Exit immediately if a command exits with a non-zero status.

BUILD_DIR=".build"
FILES_DIR="files"
MAIN_FILE=".main"
INSTALL_TEMPLATE="install.sh.in"
UNINSTALL_TEMPLATE="uninstall.sh.in"

function error_handler() {
    local message="$1"
    echo "Error: $message" >&2
    exit 1
}

function parse_main() {
    local line
    while IFS="=" read -r key value; do
        # Remove leading/trailing whitespace
        key=$(echo "$key" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
        value=$(echo "$value" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

        if [[ -n "$key" ]]; then
            # Convert to uppercase to use as variable name
            declare -g "$(echo "$key" | tr '[:lower:]' '[:upper:]')"="$value"
        fi
    done < "$MAIN_FILE"

    # Perform checks for necessary variables
    if [[ -z "$NAME" ]]; then
        error_handler "Missing required variable: Name in .main file."
    fi
    if [[ -z "$ARCH" ]]; then
        error_handler "Missing required variable: ARCH in .main file."
    fi
    if [[ -z "$VERSION" ]]; then
       error_handler "Missing required variable: VERSION in .main file"
    fi
}

function create_directories() {
    echo "CREATE DIR $NAME"
    mkdir -p "$NAME"
    echo "CREATE DIR $NAME/libs"
    mkdir -p "$NAME/libs"
    echo "CREATE DIR $NAME/bin"
    mkdir -p "$NAME/bin"
    echo "CREATE DIR $NAME/include"
    mkdir -p "$NAME/include"
    if [[ "$HEADER" == "yes" ]] ; then
        echo "CREATE DIR $NAME/include/libbb"
        mkdir -p "$NAME/include/libbb"
    fi
    echo "CREATE DIR $NAME/configs"
    mkdir -p "$NAME/configs"
}

function generate_scripts() {
    echo "GEN $NAME/install.sh"
    if [[ -f "$INSTALL_TEMPLATE" ]]; then
        sed -e "s/{{NAME}}/$NAME/g" \
            -e "s/{{AUTHOR}}/$AUTHOR/g" \
            -e "s/{{OGCODER}}/$OGCODER/g" \
            -e "s/{{COMPILEROFPKG}}/$COMPILEROFPKG/g" \
            -e "s/{{BUILDER}}/$BUILDER/g" \
            -e "s/{{VERSION}}/$VERSION/g" \
            -e "s/{{LIBS}}/$LIBS/g" \
            -e "s/{{depends}}/$depends/g" \
            -e "s/{{bins}}/$bins/g" \
            -e "s/{{Installpath}}/$Installpath/g" \
            -e "s/{{system-program}}/$system-program/g" \
            -e "s/{{ARCH}}/$ARCH/g" \
            -e "s/{{HEADER}}/$HEADER/g" \
            -e "s/{{CONFIGS}}/$CONFIGS/g" \
            "$INSTALL_TEMPLATE" > "$NAME/install.sh"
        chmod +x "$NAME/install.sh"
    else
        error_handler "Install script template not found: $INSTALL_TEMPLATE"
    fi
    echo "GEN $NAME/uninstall.sh"
    if [[ -f "$UNINSTALL_TEMPLATE" ]]; then
        sed -e "s/{{NAME}}/$NAME/g" \
            -e "s/{{AUTHOR}}/$AUTHOR/g" \
            -e "s/{{OGCODER}}/$OGCODER/g" \
            -e "s/{{COMPILEROFPKG}}/$COMPILEROFPKG/g" \
            -e "s/{{BUILDER}}/$BUILDER/g" \
            -e "s/{{VERSION}}/$VERSION/g" \
            -e "s/{{LIBS}}/$LIBS/g" \
            -e "s/{{depends}}/$depends/g" \
            -e "s/{{bins}}/$bins/g" \
            -e "s/{{Installpath}}/$Installpath/g" \
            -e "s/{{system-program}}/$system-program/g" \
            -e "s/{{ARCH}}/$ARCH/g" \
            -e "s/{{HEADER}}/$HEADER/g" \
            -e "s/{{CONFIGS}}/$CONFIGS/g" \
            "$UNINSTALL_TEMPLATE" > "$NAME/uninstall.sh"
        chmod +x "$NAME/uninstall.sh"
    else
        error_handler "Uninstall script template not found: $UNINSTALL_TEMPLATE"
    fi
}

function copy_files() {
    # Copy Libraries
    if [[ -n "$LIBS" ]]; then
        local IFS=','
        read -ra LIB_ARRAY <<< "$LIBS"
        for lib in "${LIB_ARRAY[@]}"; do
            if [[ $lib == *"dynamic"* ]]; then
                echo "CP ${lib#*=*} $NAME/libs"
                cp "$FILES_DIR/${lib#*=*}" "$NAME/libs"
            elif [[ $lib == *"needed"* ]]; then
                echo "CP ${lib#*=*} $NAME/libs"
                cp "$FILES_DIR/${lib#*=*}" "$NAME/libs"
            else
                continue
            fi
        done
    fi

    # Copy binaries
    if [[ -n "$BINS" ]]; then
        local IFS=','
        read -ra BIN_ARRAY <<< "$BINS"
        for bin in "${BIN_ARRAY[@]}"; do
            echo "CP $bin $NAME/bin"
            cp "$bin" "$NAME/bin"
        done
    fi

    # Copy headers
    if [[ "$HEADER" == "yes" ]]; then
        echo "CP $FILES_DIR/include/* $NAME/include/libbb/"
        cp -r "$FILES_DIR/include/"* "$NAME/include/libbb/"
    fi

    # Copy configs
    if [[ -n "$CONFIGS" ]]; then
        echo "CP $CONFIGS/* $NAME/configs"
        cp "$CONFIGS/"* "$NAME/configs"
    fi

    # Copy build file
    echo "CP $FILES_DIR/$BUILD_DIR $NAME/"
    cp "$FILES_DIR/$BUILD_DIR" "$NAME/"
}

function create_archive() {
    echo "TAR $NAME $NAME.tar.gz"
    tar -czf "$NAME.tar.gz" "$NAME"
    echo "MV $NAME.tar.gz $NAME.pkg"
    mv "$NAME.tar.gz" "$NAME.pkg"
}

# Main Script Execution
if [[ ! -f "$MAIN_FILE" ]]; then
    error_handler "Main file not found: $MAIN_FILE"
}

echo "PARSE $MAIN_FILE else EXIT 1"
parse_main

create_directories
generate_scripts
copy_files
create_archive

echo "Package $NAME.pkg created successfully."
           </code><button onclick="copyCode('builder-code',this)">Copy</button></pre>
        </li>
    </ol>
    <h2>Important Notes</h2>
    <ul>
        <li>Ensure that your install and uninstall scripts handle all the necessary file copying, configuration, and cleanup logic.</li>
          <li>Libraries using `dynamic=library.so` or `needed=library2.so` are copied to `/usr/lib`</li>
           <li>Binaries are copied to the Installpath</li>
           <li>Headers are placed in `/usr/include/libbb/`</li>
            <li>Configs are placed in `/etc/81pkg/packagename/`</li>
        <li>The <code>.main</code> configuration options are case sensitive.</li>
        <li>Make sure the <code>81pkg-builder</code> is executable with  <code>chmod +x 81pkg-builder</code></li>
    </ul>
     <script>
          function copyCode(elementId, button) {
            const codeElement = document.getElementById(elementId);
            const codeText = codeElement.innerText;

              navigator.clipboard.writeText(codeText)
                .then(() => {
                   button.textContent = 'Copied!';
                   setTimeout(() => {
                      button.textContent = 'Copy';
                      }, 2000);
                  })
             .catch(err => console.error('Failed to copy code:', err));
              }
      </script>
</body>
</html>
